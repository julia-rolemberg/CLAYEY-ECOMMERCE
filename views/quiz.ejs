<% titulo = "Sabonete Perfeito" %>

<div class="telaQuiz principalP2">
<!-- Início -->
    <div id="home-container" class="bg-raio text-center mx-auto">
        <div id="home-conteudo" class="q-container">
            <div class="limitador">
                <div class="t-quiz"> 
                    <h2>Sabonete Perfeito</h2>
                    <h4>Faça o quiz e descubra qual o sabonete perfeito para sua pele!</h4>
                </div>
                <div class="p-5 mt-5 img-box">
                    <img class="flutuar-girando-suave img-quiz" src="/imagens/sabaoMisterio.png"/>
                </div>
                <div><button id="start-btn" type="button" class="btn-quiz px-5">Começar</button></div>
            </div>
        </div>
    </div>

    <!-- Questões / Lista layout-->
    <div class="container-fluid">
        <div class="row">
            <div id="insert-question-container" class="col-lg-10">

            </div>
            <div id="insert-option-container" class="col-lg-2">

            </div>
        </div>
    </div>

    <!-- Questões -->
    <div id="question-container" class="d-none q-container">
        <div id="question" class="text-center h3">Question</div>
        <div id="answer-buttons" style="height:50vh">
            <button class="btn btn-light btn-lg">Resposta 1</button>
        </div>
        <div class="text-center">
            <button id="next-btn" type="button" class="btn btn-quiz2 d-none">Próximo</button>
            <button id="final-btn" type="button" class="btn btn-quiz2 d-none">Finalizar</button>
        </div>
    </div>

    <!-- Lista -->
    <div id="option-container" class="p-2 d-none lista">
        <div class="h2 p-2 mb-1 text-center">Escolhas</div>
            <div id="option-buttons" class="text-white text-center">
                <div class="p-2 bg-danger">Escolha1</div>
            </div>
        <div id="option-bar" class="mt-3 mb-1">
            
        </div>
        <div class="d-flex justify-content-center">
            <button id="result-btn" type="button" class="btn btn-secondary d-none">Resultado</button>
        </div>
    </div>
        
<!-- Resultado -->
    <div id="result-container" class="revelacao text-center d-none q-container">
        <div class="t-quiz h1">RESULTADO</div>
        <div>
            <img id="img-res" width=25% alt="imagem do sabonete" src=""/>
            <div id="txt-res" class="h2"></div>
        </div>
        <div class="p-3">
            <button id="restart-btn" type="button" class="btn btn-light btn-lg">RECOMEÇAR</button>
            <a id="btn-loja" class="btn btn-success btn-lg" href="">VER NA LOJA</a>
        </div>
    </div>

<!-- Erro -->
    <div id="error-container" class="text-center d-none q-container">
        <div class="t-quiz h1">OPS...</div>
        <div>
            <img width=25% alt="nome sabonete" src="https://weakwifisolutions.com/wp-content/uploads/2019/08/error-red-cross-1.png?ezimgfmt=rs:372x372/rscb2/ng:webp/ngcb2"/>
            <div class="h2">Desculpa, o seu resultado não foi encontrado. Por favor, tente novamente.</div>
        </div>
        <div class="p-3">
            <button id="reset-btn" type="button" class="btn btn-light btn-lg">RECOMEÇAR</button>
        </div>
    </div>
</div>

<input type="hidden" id="produtos" value='[<% for(let i in lista){ %>{"id":<%= lista[i].id_produto %>, "nome":"<%= lista[i].nome_produto%>"}<% if(i < lista.length - 1){%>,<% } %><% } %>]'/>

<%- include("quiz-questoes") %>
<script type="text/javascript">
    const startButton = document.getElementById("start-btn")
    const nextButton = document.getElementById("next-btn")
    const finalizeButton = document.getElementById("final-btn")
    const resultButton = document.getElementById("result-btn")
    const restartButton = document.getElementById("restart-btn")
    const resetButton = document.getElementById("reset-btn")
    const homeContainerElement = document.getElementById('home-container')
    const questionContainerElement = document.getElementById('question-container')
    const listContainerElement = document.getElementById("option-container")
    const resultContainerElement = document.getElementById('result-container')
    const errorContainerElement = document.getElementById('error-container')
    const questionElement = document.getElementById("question")
    const answerButtonsElement = document.getElementById("answer-buttons")

    //layout questão / lista
    const layoutQuestion = document.getElementById("insert-question-container")
    const layoutList = document.getElementById("insert-option-container")

    let currentQuestionIndex
    var escolhaAtual = ""
    var escolhas = []


    startButton.addEventListener('click', comecarJogo)
    nextButton.addEventListener('click', () => {
        escolherResposta();
        currentQuestionIndex++
        proximaPergunta()
        mostrarLista()
    })
    finalizeButton.addEventListener('click', () => {
        escolherResposta();
        currentQuestionIndex++
        telaLista()
        mostrarLista()
    })
    resultButton.addEventListener('click', obterResultado)
    restartButton.addEventListener('click', () => {location.reload()})
    resetButton.addEventListener('click', () => {location.reload()})


    function comecarJogo() {
        startButton.classList.add("d-none")
        homeContainerElement.classList.add("d-none")
        currentQuestionIndex = 0
        questionContainerElement.classList.remove("d-none")
        proximaPergunta()
    }

    function proximaPergunta() {
        resetarInstancia()
        mostrarPergunta(questoes[currentQuestionIndex])
    }

    function mostrarPergunta(questao) {
        let posicoes = [];
        questionElement.innerText = questao.titulo
        questao.alternativas.forEach(alternativa => {
            const button = document.createElement("button")
            button.innerText = alternativa.texto
            button.classList.add("btn")
            button.classList.add("btn-dark")
            button.classList.add("btn-lg")
            button.classList.add("position-absolute")
            button.classList.add("flutuar")

            //posicionamento aleatório
            let novo = true;
            do{
                var x = Math.random() * 85;
                var y = Math.random() * 62 + 25;

                for(let i = 0; i < posicoes.length; i++){
                    if(x >= posicoes[i].x - 20 && x <= posicoes[i].x + 20 && y >= posicoes[i].y - 10 && y <= posicoes[i].y + 10) {
                        novo = false
                        break;
                    }
                    novo = true
                }
            } while (!novo);

            posicoes.push({x: x, y: y})
            let estilo = "top:"+ y.toFixed(1) +"%; left: "+ x.toFixed(1) +"%;";
            button.setAttribute("style", estilo);
            button.addEventListener('click', clicouBotao)
            answerButtonsElement.appendChild(button)
        })
    }

    function resetarInstancia() {
        nextButton.classList.add("d-none")
        while(answerButtonsElement.firstChild) {
            answerButtonsElement.removeChild(answerButtonsElement.firstChild)
        }
    }

    function clicouBotao(e) {
        var selectedButton = e.target
        escolhaAtual = selectedButton.textContent
        if(questoes.length > currentQuestionIndex + 1) {
            nextButton.classList.remove("d-none")
        } else {
            finalizeButton.classList.remove('d-none')
        }
    }
    
    function escolherResposta() {
        escolhas.push(escolhaAtual)
    }

    function mostrarLista() {
        if(currentQuestionIndex === 1) {
            layoutQuestion.appendChild(questionContainerElement)
            layoutList.appendChild(listContainerElement)
        }

        listContainerElement.classList.remove("d-none")

        var lista = ""

        for(var i in escolhas) {
            lista += "<div class='p-2 div-escolha my-2'>"+ escolhas[i] +"</div>"
        }
        $('#option-buttons').html(lista);

        var barra = ""
        let perc = (currentQuestionIndex / questoes.length).toFixed(2)
        perc *= 100
        barra += "<div class='progress'>" +
				"<div class='progress-bar progress-bar-striped bg-dark progress-bar-animated active' role='progressbar'"+
                "aria-valuenow='2' aria-valuemin='0' aria-valuemax='100' style='min-width: 2em; width: " +
				perc +
				"%;'></div>" +
				"</div>"

        $('#option-bar').html(barra);
    }

    var barraCarregamento = document.getElementById('option-bar')
    function telaLista() {
        finalizeButton.classList.add('d-none')
        layoutQuestion.remove()
        layoutList.classList.remove('col-lg-2')
        layoutList.classList.add('col-lg-12')
        layoutList.classList.add('telaCheia')
        setTimeout(() => {barraCarregamento.classList.add('piscar')},2000)
        setTimeout(() => {barraCarregamento.remove(); resultButton.classList.remove('d-none');},5000)
    }

    function mostrarResultado(produto) {
        layoutList.remove()

        if(produto == false){
            errorContainerElement.classList.remove('d-none')
        } else {
            $('#img-res').attr("src", "/imagens/produtos/s" + produto.id + ".jpg")
            $('#txt-res').text(produto.nome)
            $('#btn-loja').attr("href", "/produto/"+ produto.id)
            resultContainerElement.classList.remove('d-none')
        }
    }

</script>